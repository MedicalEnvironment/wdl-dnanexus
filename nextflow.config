/*
 * Nextflow configuration file for FastQC pipeline
 * Optimized for DNAnexus Platform execution
 */

// Pipeline metadata
manifest {
    name            = 'fastqc-pipeline'
    author          = 'Converted from WDL'
    homePage        = ''
    description     = 'FastQC quality control pipeline for FASTQ files'
    mainScript      = 'main.nf'
    nextflowVersion = '>=22.10.0'
    version         = '1.0.0'
}

// Default parameters
params {
    // Input/Output parameters
    fastq_files     = null
    outdir          = './results'
    publish_mode    = 'copy'
    
    // Help message
    help            = false
    
    // Resource defaults
    max_memory      = '8.GB'
    max_cpus        = 4
    max_time        = '4.h'
}

// Process configuration
process {
    // Docker container (same as WDL runtime)
    container = 'akbarabayev/my-fastqc-dnanexus-image:latest'
    
    // Default resource requirements
    cpus   = 2
    memory = 4.GB
    time   = 2.h
    
    // Error handling
    errorStrategy = 'retry'
    maxRetries    = 2
    
    // Process-specific configurations
    withName: 'runFastQC' {
        cpus   = 2
        memory = 4.GB
        time   = 2.h
    }
}

// Execution profiles
profiles {
    // Standard profile (local execution)
    standard {
        process.executor = 'local'
        docker.enabled = true
    }
    
    // Docker profile
    docker {
        docker.enabled = true
        docker.runOptions = '-u $(id -u):$(id -g)'
    }
    
    // Singularity profile
    singularity {
        singularity.enabled = true
        singularity.autoMounts = true
    }
    
    // DNAnexus profile (optimized for Platform execution)
    dnanexus {
        // DNAnexus automatically handles container execution
        // No need to explicitly enable docker/singularity
        process {
            executor = 'local'
            
            // DNAnexus-specific resource configuration
            withName: 'runFastQC' {
                cpus   = 2
                memory = 4.GB
            }
        }
    }
    
    // Test profile (for quick testing with small data)
    test {
        params {
            fastq_files = './test_data/*.fastq.gz'
            max_memory  = '4.GB'
            max_cpus    = 2
        }
    }
}

// Container configuration
docker {
    enabled = true
    temp = 'auto'
}

singularity {
    enabled = false
    autoMounts = true
}

// Execution report options
timeline {
    enabled = true
    overwrite = true
}

report {
    enabled = true
    overwrite = true
}

trace {
    enabled = true
    overwrite = true
}

dag {
    enabled = true
    overwrite = true
}

// Function to print help message
def helpMessage() {
    log.info"""
    =========================================
    FastQC Pipeline - Usage
    =========================================
    
    Usage:
        nextflow run main.nf --fastq_files '<pattern>' --outdir <output_directory>
    
    Required arguments:
        --fastq_files       Path or glob pattern to FASTQ files (e.g., '*.fastq.gz' or '/path/to/*.fq')
        
    Optional arguments:
        --outdir            Output directory (default: ${params.outdir})
        --publish_mode      How to publish results: 'copy', 'symlink', 'move' (default: ${params.publish_mode})
        --help              Show this help message
    
    Resource options:
        --max_memory        Maximum memory per process (default: ${params.max_memory})
        --max_cpus          Maximum CPUs per process (default: ${params.max_cpus})
        --max_time          Maximum time per process (default: ${params.max_time})
    
    Examples:
        # Run with local FASTQ files
        nextflow run main.nf --fastq_files '*.fastq.gz' --outdir results
        
        # Run with specific files
        nextflow run main.nf --fastq_files 'sample_{1,2,3}.fq' --outdir fastqc_output
        
        # Run on DNAnexus (files already on platform)
        nextflow run main.nf --fastq_files 'dx://project-xxx:/input/*.fastq.gz'
    
    =========================================
    """.stripIndent()
}

// Show help message if requested
if (params.help) {
    helpMessage()
    exit 0
}
